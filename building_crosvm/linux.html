<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>For Linux - Book of crosvm</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../building_crosvm/index.html"><strong aria-hidden="true">2.</strong> Building Crosvm</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../building_crosvm/linux.html" class="active"><strong aria-hidden="true">2.1.</strong> For Linux</a></li><li class="chapter-item expanded "><a href="../building_crosvm/chromium_os.html"><strong aria-hidden="true">2.2.</strong> For Chromium OS</a></li></ol></li><li class="chapter-item expanded "><a href="../running_crosvm/index.html"><strong aria-hidden="true">3.</strong> Running Crosvm</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../running_crosvm/usage.html"><strong aria-hidden="true">3.1.</strong> Usage</a></li><li class="chapter-item expanded "><a href="../running_crosvm/requirements.html"><strong aria-hidden="true">3.2.</strong> System Requirements</a></li><li class="chapter-item expanded "><a href="../running_crosvm/features.html"><strong aria-hidden="true">3.3.</strong> Features</a></li><li class="chapter-item expanded "><a href="../running_crosvm/devices.html"><strong aria-hidden="true">3.4.</strong> Devices</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture.html"><strong aria-hidden="true">4.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../contributing.html"><strong aria-hidden="true">5.</strong> Contributing</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../appendix/index.html"><strong aria-hidden="true">6.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../appendix/example_usage.html"><strong aria-hidden="true">6.1.</strong> Example Usage (Outdated)</a></li><li class="chapter-item expanded "><a href="../appendix/sandboxing.html"><strong aria-hidden="true">6.2.</strong> Sandboxing</a></li><li class="chapter-item expanded "><a href="../appendix/seccomp.html"><strong aria-hidden="true">6.3.</strong> Seccomp</a></li><li class="chapter-item expanded "><a href="../appendix/minijail.html"><strong aria-hidden="true">6.4.</strong> Minijail</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../api.html">API Documentation</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Book of crosvm</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="building-for-linux"><a class="header" href="#building-for-linux">Building for Linux</a></h1>
<p>Crosvm uses submodules to manage external dependencies. Initialize them via:</p>
<pre><code class="language-sh">git submodule update --init
</code></pre>
<p>It is recommended to enable automatic recursive operations to keep the
submodules in sync with the main repository (But do not push them, as that can
conflict with <code>repo</code>):</p>
<pre><code class="language-sh">git config --global submodule.recurse true
git config push.recurseSubmodules no
</code></pre>
<p>Crosvm requires a couple of dependencies. For Debian derivatives these can be
installed by (Depending on which feature flags are used, not all of these will
actually be required):</p>
<pre><code class="language-sh">sudo apt install \
    bindgen \
    build-essential \
    clang \
    libasound2-dev \
    libcap-dev \
    libdbus-1-dev \
    libdrm-dev \
    libepoxy-dev \
    libssl-dev \
    libwayland-bin \
    libwayland-dev \
    pkg-config \
    protobuf-compiler \
    python3 \
    wayland-protocols
</code></pre>
<p>And that's it! You should be able to <code>cargo build/run/test</code>.</p>
<h2 id="known-issues"><a class="header" href="#known-issues">Known issues</a></h2>
<ul>
<li>By default, crosvm is running devices in sandboxed mode, which requires
seccomp policy files to be set up. For local testing it is often easier to
<code>--disable-sandbox</code> to run everything in a single process.</li>
<li>If your Linux header files are too old, you may find minijail rejecting
seccomp filters for containing unknown syscalls. You can try removing the
offending lines from the filter file, or add <code>--seccomp-log-failures</code> to the
crosvm command line to turn these into warnings. Note that this option will
also stop minijail from killing processes that violate the seccomp rule,
making the sandboxing much less aggressive.</li>
<li>Seccomp policy files have hardcoded absolute paths. You can either fix up
the paths locally, or set up an awesome hacky symlink: <code>sudo mkdir /usr/share/policy &amp;&amp; sudo ln -s /path/to/crosvm/seccomp/x86_64 /usr/share/policy/crosvm</code>. We'll eventually build the precompiled policies
<a href="http://crbug.com/1052126">into the crosvm binary</a>.</li>
<li>Devices can't be jailed if <code>/var/empty</code> doesn't exist. <code>sudo mkdir -p /var/empty</code> to work around this for now.</li>
<li>You need read/write permissions for <code>/dev/kvm</code> to run tests or other crosvm
instances. Usually it's owned by the <code>kvm</code> group, so <code>sudo usermod -a -G kvm $USER</code> and then log out and back in again to fix this.</li>
<li>Some other features (networking) require <code>CAP_NET_ADMIN</code> so those usually
need to be run as root.</li>
</ul>
<h2 id="running-crosvm-tests-on-linux"><a class="header" href="#running-crosvm-tests-on-linux">Running crosvm tests on Linux</a></h2>
<h3 id="installing-podman-or-docker"><a class="header" href="#installing-podman-or-docker">Installing Podman (or Docker)</a></h3>
<p>See <a href="https://podman.io/getting-started/installation">Podman Installation</a> for
instructions on how to install podman.</p>
<p>For Googlers, see <a href="http://go/dont-install-docker">go/dont-install-docker</a> for
special instructions on how to set up podman.</p>
<p>If you already have docker installed, that will do as well. However podman is
recommended as it will not run containers with root privileges.</p>
<h3 id="running-all-tests"><a class="header" href="#running-all-tests">Running all tests</a></h3>
<p>To run all tests for all platforms, just run:</p>
<pre><code>./test_all
</code></pre>
<p>This will run all tests using the x86 and aarch64 builder containers. What does
this do?</p>
<ol>
<li>
<p>It will start <code>./ci/[aarch64_]builder --vm</code>.</p>
<p>This will start the builder container and launch a VM for running tests in
the background. The VM is booting while the next step is running.</p>
</li>
<li>
<p>It will call <code>./run_tests</code> inside the builder</p>
<p>The script will pick which tests to execute and where. Simple tests can be
executed directly, other tests require privileged access to devices and will
be loaded into the VM to execute.</p>
<p>Each test will in the end be executed by a call to <code>cargo test -p crate_name</code>.</p>
</li>
</ol>
<p>Intermediate build data is stored in a scratch directory at <code>./target/ci/</code> to
allow for faster subsequent calls (Note: If running with docker, these files
will be owned by root).</p>
<h3 id="fast-iterative-test-runs"><a class="header" href="#fast-iterative-test-runs">Fast, iterative test runs</a></h3>
<p>For faster iteration time, you can directly invoke some of these steps directly:</p>
<p>To only run x86 tests: <code>./ci/[aarch64_]builder --vm ./run_tests</code>.</p>
<p>To run a simple test (e.g. the tempfile crate) that does not need the vm:
<code>./ci/[aarch64_]builder cargo test -p tempfile</code>.</p>
<p>Or run a single test (e.g. kvm_sys) inside the vm: <code>./ci/[aarch64*]builder --vm cargo test -p kvm_sys</code>.</p>
<p>Since the VM (especially the fully emulated aarch64 VM) can be slow to boot, you
can start an interactive shell and run commands from there as usual. All cargo
tests will be executed inside the VM, without the need to restart the VM between
test calls.</p>
<pre><code class="language-sh">host$ ./ci/aarch64_builder --vm
crosvm-aarch64$ ./run_tests
crosvm-aarch64$ cargo test -p kvm_sys
...
</code></pre>
<h3 id="running-tests-without-docker"><a class="header" href="#running-tests-without-docker">Running tests without Docker</a></h3>
<p>Specific crates can be tested as usual with <code>cargo test</code> without the need for
Docker. However, because of special requirements some of them will not work,
which means that <code>cargo test --workspace</code> will also not work to run all tests.</p>
<p>For this reason, we have a separate test runner <code>./run_tests</code> which documents
the requirements of each crate and picks the tests to run. It is used by the
Docker container to run tests, but can also be run outside of the container to
run a subset of tests.</p>
<p>See <code>./run_tests --help</code> for more information.</p>
<h3 id="reproducing-kokoro-locally"><a class="header" href="#reproducing-kokoro-locally">Reproducing Kokoro locally</a></h3>
<p>Kokoro runs presubmit tests on all crosvm changes. It uses the same builders and
the same <code>run_tests</code> script to run tests. This should match the results of the
<code>./test_all</code> script, but if it does not, the kokoro build scripts can be
simulated locally using: <code>./ci/kokoro/simulate_all</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../building_crosvm/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../building_crosvm/chromium_os.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../building_crosvm/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../building_crosvm/chromium_os.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../mermaid.min.js"></script>
        <script type="text/javascript" src="../mermaid-init.js"></script>
    </body>
</html>
